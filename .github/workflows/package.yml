name: Package Plugins & Update Index

on:
  push:
    paths-ignore:
      - 'README.md'
      - '.gitignore'
      # We DO NOT ignore index.yml anymore, because we might edit it manually
      # But we will use [skip ci] in the commit message to prevent loops
  workflow_dispatch:

permissions:
  contents: write

jobs:
  package-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          # Install yq (command line YAML editor)
          wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      - name: Package and Update Hash
        run: |
          git config --global user.name 'GitHub Action'
          git config --global user.email 'action@github.com'

          # Loop through directories
          for dir in */ ; do
            plugin_name=${dir%/}
            
            # Skip .github folder
            if [[ "$plugin_name" == ".github" ]]; then continue; fi

            echo "------------------------------------------------"
            echo "ðŸ“¦ Processing: $plugin_name"

            # 1. ZIP THE FOLDER
            cd "$plugin_name"
            zip -r -FS "$plugin_name.zip" . -x "*.zip"
            cd ..

            # 2. CALCULATE HASH
            # Get the sha256 hash of the new zip file
            NEW_HASH=$(sha256sum "$plugin_name/$plugin_name.zip" | awk '{print $1}')
            echo "   Hash: $NEW_HASH"

            # 3. UPDATE INDEX.YML
            # We use yq to find the entry where the 'path' contains the zip name
            # and update the 'sha256' field for that entry.
            
            # Logic: Find array item -> select where path contains "plugin.zip" -> update sha256
            yq -i "(.[] | select(.path | contains(\"$plugin_name.zip\"))).sha256 = \"$NEW_HASH\"" index.yml
            
            # Stage the zip file
            git add "$plugin_name/$plugin_name.zip"
          done

          # Stage the index.yml file
          git add index.yml

      - name: Commit and Push
        run: |
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            # [skip ci] is crucial to prevent the action from triggering itself infinitely
            git commit -m "Auto-package and update hashes [skip ci]"
            git push
          fi
